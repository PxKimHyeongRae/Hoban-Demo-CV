# v29~v30 분석 + v31 방향 결정

## 전체 버전 비교

| 버전 | Fallen 수 | Fallen AP50 | SAHI F1 | OFF F1 | 핵심 변경 |
|------|-----------|-------------|---------|--------|-----------|
| v25 | 568 (area<5%) | 0.551 | - | - | baseline |
| v26 | 1,074 (area<10%) | 0.774 | 0.958 | 0.924 | cp=0.4, scale=0.7 |
| v27 | 2,000 (real+synth) | 0.716 | 0.956 | - | 합성 데이터 (역행) |
| v28 | 2,073 (v24+unified) | 0.784 | 0.957 | 0.918 | unified area<5% |
| **v29** | **2,000 (v24 전체)** | **0.841** | **0.955** | **0.930** | **close_mosaic=0, 랜덤** |
| v30 | 1,212 (stratified) | 0.789 | 0.953 | 0.918 | val 분포 매칭 (역행) |

## v30 실패 원인 (3가지 복합)

### 1. Unified 데이터 품질 천장 (기여도 44%)
- unified 비율 70%+ 버전은 모두 mAP50 ~0.895에서 정체
- v29(unified 0%)=0.920, v28(unified 73%)=0.895, v30(unified 70%)=0.894
- AIHub unified_safety_all은 건설현장 fallen과 도메인 시프트 존재

### 2. 데이터 양 부족 (기여도 35%)
- v30: 1,212장 vs v29: 2,000장 (-39.4%)
- area 쿼터로 구간별 제한 → 전체 볼륨 감소
- 아직 데이터 증가가 유효한 구간 (포화 안 됨)

### 3. 분포 매칭 역설 (기여도 21%)
- v30은 tiny(<1%) 비율을 val과 동일하게 25%로 맞춤
- v29는 tiny 10.3%로 적지만, 중~대형이 풍부
- 중~대형으로 feature를 먼저 잘 학습한 뒤 tiny에 전이되는 curriculum 효과

## v29 성공 요인

### close_mosaic=0 (확정)
- 과적합 2.5배 감소: cm=10 gap=0.235 vs cm=0 gap=0.094
- cm=10 버전은 마지막 10ep에서 val_box +0.016 증가 (악화)
- cm=0 버전은 -0.005 감소 (개선 지속)

### v24 전체 2,000장 (area 필터 없음)
- 중~대형 fallen(>10%): v29 47.6% vs v26 17%
- 다양한 스케일을 한번에 학습 → 강건한 feature

### unified 미사용
- v24만 사용하여 도메인 시프트 없는 깨끗한 데이터

### 아직 개선 여지 있음
- Best epoch: 81/100 (마지막 19ep 활용 안 됨)
- Val loss 아직 하강 중 (기울기 -0.000305/ep)
- Overfit gap 0.066 (전 버전 중 최소)

## v31 실험 방향

### 채택: v29 + Extended Training
- **데이터셋**: v29 그대로 (helmet 2,000 + v24 fallen 2,000 = 4,000)
- **epochs**: 100 → 150
- **patience**: 25 → 35
- 예상 fallen AP50: 0.841 → **0.85~0.86**

### 핵심 근거
1. v29 val loss가 epoch 100에서 아직 하강 중
2. Best epoch 81로 19ep 여유 → 150ep이면 50ep 이상 추가 여유
3. 리스크 최소 (데이터/모델 변경 없이 epoch만 증가)
4. close_mosaic=0이 과적합을 억제하므로 장기 학습 가능

## 학습된 규칙

1. **v24 > unified**: 도메인 일치 데이터가 양보다 중요
2. **close_mosaic=0 필수**: 모든 후속 실험에 적용
3. **area 필터 제거**: 다양한 스케일 포함이 유리
4. **분포 매칭 < 데이터 양**: 같은 소스에서는 양이 우선
