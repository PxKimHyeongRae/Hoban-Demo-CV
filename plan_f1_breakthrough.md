# SAHI F1 돌파 분석 — 오탐(FP) 중심 (2026-02-22)

## 1. 현황: F1 = 0.928 천장

### 1.1 모델별 성능 (평가셋 605장 기준, 중복 제거 후)

| Version | SAHI F1 | TP | FP | FN | P | R |
|---------|---------|----|----|----|----|-----|
| v19 (best) | 0.922* | 1,092 | 132 | 54 | 0.892 | 0.953 |
| v21-l | 0.923 | - | ~153 | ~51 | 0.888 | 0.960 |
| v23 | 0.919 | - | ~134 | ~76 | 0.899 | 0.940 |
| v17 | 0.918 | - | ~134 | ~76 | 0.899 | 0.940 |

> *605장 기준 재평가 필요 (기존 729장 → 중복 124장 제거)

### 1.2 FP 상세 분석 (v19, 132개)

**클래스별:**
- helmet_on FP: **108개** (82%)
- helmet_off FP: **24개** (18%)

**크기별:**
- **tiny (<0.1% area): 124개 (94%)**
- small (0.1-0.5%): 8개 (6%)
- medium+ (>0.5%): 0개

**Confidence 분포:**
```
conf >= 0.9:   4개 (3%)
conf >= 0.8:  29개 (22%)
conf >= 0.7:  69개 (52%)
conf >= 0.6: 101개 (77%)
conf >= 0.5: 124개 (94%)
```
→ FP의 52%가 conf≥0.7 고신뢰도. 단순 conf 올리기로 해결 불가.

### 1.3 FP 패턴 분류 (크롭 시각화 결과)

| 패턴 | 설명 | 비중(추정) | 제거 가능성 |
|------|------|-----------|------------|
| **A. GT 미라벨** | 실제 사람인데 GT에 없음 (특히 배경 인물) | ~40-50% | GT 보완으로 해결 |
| **B. 장비/배경 오탐** | 차량, 안전 표지판, 장비가 helmet처럼 보임 | ~30-40% | negative 학습으로 개선 |
| **C. SAHI 아티팩트** | 타일 경계에서 잘린 객체의 오탐 | ~10-20% | gate 강화로 개선 |

**핵심 발견: "FP" 132개 중 상당수(40-50%)가 실제로는 GT 누락.**
→ 현재 F1이 과소평가되고 있을 가능성.

### 1.4 FN 분석 (54개)

- helmet_on FN: 47개 (87%)
- helmet_off FN: 7개 (13%)
- **98%가 tiny** → 물리적으로 탐지가 어려운 극소 객체

---

## 2. 근본 원인

### 원인 #1: GT 라벨 품질 (가장 큰 요인)

**문제**: 605장 val에서 GT가 불완전:
- 배경의 먼 인물이 라벨링되지 않음
- 모델이 정확하게 탐지해도 GT 매칭 실패 → "FP"로 카운트
- conf 0.85-0.88의 "FP"가 실제 크롭에서 사람으로 확인됨

**영향**: FP 132개 중 ~50-60개가 GT 미라벨이라면:
- 실제 FP = ~70개, 실제 TP = ~1,152
- 실제 P = 1,152/(1,152+70) = 0.943
- 실제 F1 ≈ 0.948 (현재 0.922보다 +2.6%p 높음)

**결론**: **F1 개선의 가장 빠른 방법은 GT 보완**

### 원인 #2: Tiny Object의 물리적 한계

- FP 94%, FN 98%가 tiny (<0.1% area = ~19×35px at 1280px)
- 2px 오차로 IoU 0.73까지 하락 → false negative
- CCTV에서 20px 물체의 helmet 여부 식별은 사람도 어려움

### 원인 #3: helmet_on FP 편중 (82%)

- helmet_on(cls=0) FP가 압도적: 108 vs 24
- 건설현장 배경의 둥근 물체(안전모 형상)를 모두 helmet_on으로 탐지
- 안전 표지판, 장비 돌출부, 차량 부품 등

### 원인 #4: SAHI 타일 경계 아티팩트

- SAHI 타일 경계에서 잘린 객체가 일부 오탐으로 이어짐
- gate 메커니즘이 대부분 잡지만 일부 통과

---

## 3. 돌파 전략 (오탐 감소 + F1 최대화)

### Strategy 1: GT 보완 (최우선, 즉시 실행)

**방법**:
1. v19 모델의 FP 132개를 전수 크롭 시각화
2. 각 FP를 수동 분류: (A) GT 미라벨 / (B) 진짜 FP / (C) 모호
3. (A)에 해당하는 것을 GT에 추가 (re-annotation)
4. 보완된 GT로 재평가

**작업량**: FP 132개 크롭 검수 = ~1시간
**예상 효과**:
- GT 미라벨 50개 보완 시: FP 132→82, TP 1092→1142
- F1: 0.922 → **0.944** (+2.2%p)

**이것이 가장 확실하고 빠른 F1 개선 방법**

### Strategy 2: Hard Negative Mining 강화

**방법**:
1. 현재 negative 데이터(사람 없는 이미지)에 더해
2. **FP가 자주 발생하는 이미지의 배경 크롭**을 negative로 추가
3. 특히 안전 표지판, 장비 근접 크롭
4. v19 fine-tune (lr0=0.001, 30ep)

**예상 효과**: 패턴 B(장비/배경 오탐) 30-40% 감소
→ FP ~20개 감소 → F1 +0.5~1.0%p

### Strategy 3: GT 미라벨 해결 후 conf threshold 재최적화

**방법**:
1. Strategy 1로 GT 보완 후
2. 보완된 GT 기준으로 per-class conf sweep 재실행
3. GT가 정확해지면 최적 conf가 달라질 수 있음

**예상 효과**: +0.2~0.5%p 추가

### Strategy 4: Aspect Ratio 필터 추가

**방법**:
1. FP bbox의 aspect ratio 분석 → 장비 FP는 비정상적 비율일 수 있음
2. 사람 bbox의 일반적 aspect ratio (0.3~0.8 w/h) 범위 외의 탐지 제거
3. 후처리 파이프라인에 추가

**예상 효과**: +0.1~0.3%p (소수 FP만 해당)

### Strategy 5: 2-stage 검증 (FP 판별 모델)

**방법**:
1. 탐지된 bbox를 크롭하여 분류 모델에 통과
2. "사람/비사람" 이진 분류기로 FP 필터링
3. 작은 분류 모델 (ResNet-18 등) 충분

**예상 효과**: FP 30-50% 감소 → F1 +1~2%p
**단점**: 추론 시간 증가, 파이프라인 복잡도 증가

### Strategy 6: video_indoor 특화 — Temporal Consistency

**방법** (배포 환경 한정):
1. 단일 프레임 FP는 시간적으로 불안정 (1-2프레임만 나타남)
2. 이미 적용 중인 class stability (15프레임 중 12프레임)가 대부분 처리
3. track-level confidence 누적으로 추가 필터링

**예상 효과**: 실시간 환경에서 FP 80%+ 제거 (이미 적용 중)

---

## 4. 실행 순서

```
Day 1 (2시간):
  Strategy 1 — GT 보완
  ├─ FP 132개 전수 크롭 생성 (완료)
  ├─ 수동 분류: GT 미라벨 / 진짜 FP / 모호
  ├─ GT 미라벨 bbox 추가
  └─ 보완된 GT로 v19 재평가 → 실제 F1 확인

Day 1 (평가 후):
  Strategy 3 — conf threshold 재최적화
  └─ 보완 GT 기준 per-class conf sweep

Day 2:
  Strategy 2 — Hard Negative Mining
  ├─ FP 이미지에서 배경 크롭 → negative 데이터 추가
  └─ v19 fine-tune (30ep)

Day 3:
  종합 평가 → 배포 결정
```

## 5. 오탐 제거 목표

| 현재 | 목표 | 방법 |
|------|------|------|
| FP 132 | **FP < 80** | GT 보완 (~50개 미라벨 해결) |
| FP 132 | **FP < 60** | + hard negative mining (~20개 감소) |
| F1 0.922 | **F1 > 0.945** | GT 보완만으로 달성 가능 |
| F1 0.922 | **F1 > 0.950** | GT 보완 + hard negative + conf 재최적화 |

## 6. 핵심 결론

**F1 천장의 가장 큰 원인은 모델이 아니라 GT 품질.**

1. FP 132개 중 40-50%는 GT 미라벨 (실제로는 정확한 탐지)
2. 모델 변경/데이터 추가 전에 **GT 보완이 최우선**
3. GT 보완만으로 F1 0.922 → 0.944+ 가능
4. 진짜 FP(장비/배경 오탐)는 hard negative mining으로 추가 개선
5. FN 54개의 98%는 tiny → 물리적 한계, 큰 개선 어려움

**모델은 이미 충분히 좋다. GT가 모델을 따라가지 못하고 있다.**
