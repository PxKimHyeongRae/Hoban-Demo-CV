# datasets_v8 품질 이슈 및 해결 방안

## v8_sub 실험 결과 (3K bbox/cls, 30에폭)

| 지표 | v7_sub | v8_sub | 변화 |
|------|--------|--------|------|
| mAP50 | 0.779 | **0.801** | +2.2%p |
| mAP50-95 | 0.476 | **0.491** | +1.5%p |

v8이 v7 대비 개선되었으나, confusion matrix에서 3가지 주요 문제 발견.

---

## 문제 1: Person 미탐 38% (230/602건)

### 현상
- person을 아예 탐지 못하는 비율이 38%
- 다른 클래스와 혼동은 없음 (순수 미탐)

### 원인: COCO person 데이터의 작은 bbox

| 크기 구간 | bbox 수 | 비율 | 640px 기준 |
|-----------|---------|------|-----------|
| area < 1% (탐지불가) | 93,759 | **48.0%** | ~64px 이하 |
| area 1~2% (어려움) | 25,165 | 12.9% | 64~90px |
| area 2~10% (가능) | 48,369 | 24.8% | 90~200px |
| area > 10% (양호) | 28,084 | 14.4% | 200px 이상 |

- COCO 전체 195,377 bbox 중 **절반이 640px에서 탐지 불가능한 크기**
- 이미지당 평균 6.6명 → 군중 사진 다수 (건설현장과 다른 환경)
- 640px 리사이즈 시 5%ile = ~18x18px, 중앙값 = ~67x67px

### 해결 방안
| 방법 | 설명 | 데이터 필요 |
|------|------|-----------|
| **COCO 작은 bbox 필터링** | area < 2% 제거 → ~76K bbox 남음 | 불필요 |
| **이미지당 bbox 수 제한** | 10명 초과 군중 사진 제외 | 불필요 |
| **imgsz 올리기** | 640 → 800~1024 | 불필요 |
| 건설현장 person 데이터 추가 | 도메인 갭 해소 | **필요** |

---

## 문제 2: Background FP 높음 (총 605건)

### 현상
- 배경(아무것도 없는 곳)을 객체로 오탐
- helmet_x FP가 187건으로 최다

| 클래스 | Background FP |
|--------|--------------|
| helmet_o | 141건 |
| **helmet_x** | **187건** |
| person | 148건 |
| fallen | 129건 |

### 원인: Negative sample 부재
- 현재 학습 데이터의 **모든 이미지에 객체가 존재**
- 모델이 "아무것도 없는 이미지"를 학습한 적이 없음
- 따라서 배경에서도 무조건 무언가를 찾으려 함

### 해결 방안
| 방법 | 설명 | 데이터 필요 |
|------|------|-----------|
| **Negative sample 추가** | 객체 없는 이미지를 빈 라벨로 추가 (500~1000장) | 부분 필요 |
| **Confidence threshold 조정** | 추론 시 0.25 → 0.4 (학습 변경 없음) | 불필요 |
| **cls loss weight 증가** | 1.0 → 1.5 (분류에 더 집중) | 불필요 |

> Negative sample은 COCO에서 person 없는 이미지를 활용하면 추가 수집 불필요

---

## 문제 3: Helmet_o ↔ Helmet_x 혼동 (109건)

### 현상
- helmet_o → helmet_x 오분류: 56건
- helmet_x → helmet_o 오분류: 53건

### 원인: bbox가 머리/헬멧 부분만 잡고 있으며, 대부분 매우 작음

**helmet_o (cls 0) bbox 크기 분포 - 29,591개:**

| 크기 구간 | bbox 수 | 비율 |
|-----------|---------|------|
| area < 0.5% (탐지불가) | 20,482 | **69.2%** |
| area 0.5~1% | 5,108 | 17.3% |
| area 1~2% | 2,341 | 7.9% |
| area 2~10% | 1,506 | 5.1% |
| area > 10% | 154 | 0.5% |

**helmet_x (cls 1) bbox 크기 분포 - 36,192개:**

| 크기 구간 | bbox 수 | 비율 |
|-----------|---------|------|
| area < 0.5% (탐지불가) | 29,655 | **81.9%** |
| area 0.5~1% | 4,774 | 13.2% |
| area 1~2% | 1,267 | 3.5% |
| area 2~10% | 481 | 1.3% |
| area > 10% | 15 | 0.0% |

- bbox가 **"사람 전체"가 아니라 "머리/헬멧 부분만"** 잡고 있음
- aihub 데이터가 CCTV 원거리 촬영이라 머리가 매우 작게 찍힘
- 640px 리사이즈 시 중앙값: helmet_o ~35px, helmet_x ~30px
- **30px짜리 bbox에서 헬멧 유무 구분은 사람 눈으로도 어려움**

### bbox 시각화 확인
`bbox_check/` 폴더에 각 10장씩 저장됨:
- `helmet_o_01~10.jpg`: 초록 bbox, 번호 작을수록 작은 bbox
- `helmet_x_01~10.jpg`: 빨간 bbox, 번호 작을수록 작은 bbox

### 해결 방안
| 방법 | 설명 | 데이터 필요 |
|------|------|-----------|
| **imgsz 1280** | 작은 bbox가 2배 커짐 (30px→60px) | 불필요 |
| **작은 bbox 필터링** | area < 0.5% 제거 → 노이즈 감소 | 불필요 |
| 다양한 환경 데이터 추가 | 야간, 역광, 다양한 각도 | **필요** |

> 필터링 시 주의: helmet_x는 area 2% 이상이 496개뿐. 과도한 필터링 시 데이터 부족

---

## 문제 4: Fallen 데이터 품질 불확실

### 현상
- v8_sub에서 fallen 자체 성능은 양호 (501/600 정탐)
- 하지만 pool 자체의 라벨 품질이 검증되지 않음

### fallen_pool 품질 검증 결과

| 항목 | 수량 | 비율 | 위험도 |
|------|------|------|--------|
| 매우 작은 bbox (area < 0.5%) | 4,479 | 13.6% | 중간 |
| 매우 큰 bbox (area > 70%) | 1,126 | 3.4% | 높음 |
| 이미지당 bbox 38개 | 존재 | - | 높음 |
| fall2 (aug3x 증강 데이터) | 5,538장 | 23.4% | 중간 |

### 해결 방안
- 일단 현재 데이터로 학습 후 confusion matrix에서 fallen 성능으로 판단
- 문제 발견 시 area 필터링 + 증강 데이터(fall2) 제거

---

## 종합 해결 우선순위

### 추가 데이터 없이 할 수 있는 것 (즉시 적용 가능)

| 우선순위 | 방법 | 해결하는 문제 |
|---------|------|-------------|
| 1 | **COCO person 작은 bbox 필터링** (area < 2% 제거) | Person 미탐 |
| 2 | **imgsz 640 → 800~1280** | Helmet 혼동 + Person 미탐 |
| 3 | **COCO negative sample 추가** (person 없는 이미지) | Background FP |
| 4 | **Helmet 작은 bbox 필터링** (area < 0.5% 제거) | Helmet 혼동 |
| 5 | **Fallen 큰 bbox 필터링** (area > 70% 제거) | Fallen 노이즈 |
| 6 | **cls loss weight 조정** (1.0 → 1.5) | Background FP |

### 추가 데이터가 필요한 것

| 방법 | 해결하는 문제 | 난이도 |
|------|-------------|--------|
| 건설현장 person 데이터 | Person 미탐 (도메인 갭) | 높음 |
| 다양한 환경 helmet 데이터 | Helmet 혼동 | 높음 |
| 실외 fallen 데이터 | Fallen 다양성 | 중간 |

---

## 핵심 교훈

1. **데이터 양보다 질**: 10만 bbox를 넣어도 절반이 탐지 불가 크기면 무의미
2. **bbox 크기가 핵심**: 640px 기준 최소 50~60px 이상이어야 학습 가능
3. **Negative sample 필수**: 모든 이미지에 객체가 있으면 FP 증가
4. **도메인 매칭**: COCO 일반 사진 ≠ 건설현장 → person 탐지 한계
