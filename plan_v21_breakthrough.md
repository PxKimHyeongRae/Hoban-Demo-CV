# v21 돌파 계획

## 현황
- **v19 (현재 최고)**: SAHI F1=0.928, mAP50=0.960, mAP50-95=0.724
- **v20**: SAHI F1=0.915 (데이터 더 넣었으나 하락)
- **v17 (배포중)**: SAHI F1=0.918, mAP50=0.958

## Phase 1: 오류 분석 ✅ 완료

v19 모델 SAHI 평가 후 FP/FN 전수 분석:

| 항목 | 값 |
|------|-----|
| GT | 1,270 |
| Pred | 1,367 |
| TP | 1,222 |
| FP | 145 (helmet_on=117, helmet_off=28) |
| FN | 48 (helmet_on=40, helmet_off=8) |
| P / R / F1 | 0.894 / 0.962 / 0.927 |

### 핵심 발견
- **FP 94% tiny** (<0.1% 면적, ~30px) — 배경에서 사람으로 오탐
- **FN 98% tiny** — 너무 작아서 미탐
- **GT 89.4% tiny** — CCTV 특성상 대부분 소형 객체, 필터링 불가
- **helmet_on이 FP/FN 모두 지배적** (81%/83%)

→ 결론: 오류의 본질은 **tiny object detection 능력 한계**

## Phase 2: 실험 결과 ✅ 완료

### 2-1. 후처리 파라미터 sweep

| 실험 | 최고 F1 | 비고 |
|------|---------|------|
| min_area 0~5e-5 (1280x720) | 0.9268 | 현재 설정 이미 최적 |
| min_area 1e-4 | 0.9239 | FP↓30 but FN↑33 (악화) |
| per-class conf sweep | 0.9252 | 개선 없음 |
| **SAHI 960x540** | **0.9276** | +0.08%p (무의미) |
| SAHI 640x480 | <0.925 | 악화 |

→ 결론: **후처리 파라미터 최적화는 천장 도달**

### 2-2. 데이터 추가 효과

| 버전 | 데이터 | SAHI F1 | mAP50-95 |
|------|--------|---------|----------|
| v17 | 10,564 (COCO pt) | 0.918 | 0.722 |
| v19 | 10,852 (+288) | **0.928** | 0.724 |
| v20 | 12,470 (+1,906) | 0.915 | **0.727** |

- v20 mAP50-95는 최고이나 SAHI F1은 하락 → mAP과 SAHI F1은 불일치
- 데이터 양 증가가 반드시 실전 성능 향상으로 이어지지 않음

→ 결론: **같은 모델에서 데이터만으로는 한계**

### 2-3. Tiny GT 검증

- 전체 GT 1,270개 중 1,135개(89.4%)가 tiny
- 크롭+확대 검증 결과 실제 유효한 라벨 (노이즈 아님)
- CCTV 고정 카메라 특성상 소형 객체가 지배적

→ 결론: **tiny를 필터링할 수 없음, 탐지해야 함**

### 2-4. 기존 확인된 사항
- 앙상블 (v17+v16+v13 NMS/WBF): 개선 없음
- v13은 SAHI와 호환 안됨 (탐지 수 극히 적음)

## Phase 3: 모델 크기 확장 ← 현재 단계

### 방향: yolo26l (26.3M params, COCO pretrained)

| 모델 | Params | Pretrained | Batch@1280 |
|------|--------|-----------|------------|
| yolo26m (현재) | 21.8M | COCO ✅ | 6 |
| **yolo26l (v21)** | **26.3M** | **COCO ✅** | **4~5** |
| yolo26x (후보) | 59.0M | COCO ✅ | 2 |

선택 근거:
- 오류 94%가 tiny → 모델 capacity 증가로 tiny feature 추출력 향상 기대
- COCO pretrained 사용 → 12K 데이터에서도 과적합 위험 낮음
- l 먼저 검증 → 효과 있으면 x도 시도, 없으면 다른 방향

### 학습 설정
- 스크립트: `train_go3k_v21_l.py`
- 데이터: v19 dataset (12,470 train)
- 하이퍼파라미터: v17과 동일 (SGD lr0=0.005, patience=20)
- 출력: `hoban_go3k_v21_l/`

## 미시도 방향 (v21-l 결과 후 판단)

| 방향 | 기대 | 조건 |
|------|------|------|
| yolo26x (59M) | +2~3%p | v21-l 개선 시 |
| 고해상도 1536px+ | tiny→small 승격 | VRAM 제한 (batch=2) |
| 외부 데이터 helmet_60k | 다양성 | JSON→YOLO 변환 필요 |
| TTA | +0.5~1%p | 추론시간 3배 |
| RT-DETR | attention 기반 | 아키텍처 전환 |
